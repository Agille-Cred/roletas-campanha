<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ROLETA PREMIADA</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="main-container">
      <div class="navbar">
        <div class="nav-links">
          <a href="index.html">Roleta Dourada</a>
          <a href="roleta_premiada.html" class="active">Roleta Premiada</a>
        </div>
        <div class="nav-controls">
            <button id="spinBtn"><b>Girar</b> (ESPAÇO)</button>
            <button id="resetBtn">Reset</button>
            <button id="fsBtn">Tela cheia (F)</button>
            <button id="editPrizesBtn">Editar Prêmios</button>
        </div>
      </div>

    <div class="wrap">
      <div class="stage">
        <div class="hint" id="hint">Clique em <b>Girar</b> ou pressione <b>ESPAÇO</b></div>
        <canvas id="wheel" width="1180" height="1180" aria-label="Roleta"></canvas>
        <div class="pointer"></div>
        <div id="overlay" class="overlay" role="dialog" aria-live="polite">
          <div class="result-card">
            <small>Resultado:</small>
            <h2 id="resultText">—</h2>
            <button id="closeBtn">Fechar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="prizeModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Editar Prêmios</h2>
      <p>Digite um prêmio por linha. As linhas em branco serão ignoradas.</p>
      <textarea id="prizeInput" rows="10"></textarea>
      <div class="modal-actions">
        <button id="cancelPrizesBtn">Cancelar</button>
        <button id="savePrizesBtn">Salvar Alterações</button>
      </div>
    </div>
  </div>
  <audio id="somVitoria" src="vitoria.mp3" preload="auto"></audio>

<script>
/* =========================
   CONFIGURAÇÃO DA ROLETA
========================= */
const localStorageKey = 'prizes_premiada'; 
const PRIZES = [
  'Garrafa Stanley', 'Caixa de Som','Fone Bluetooth','Caixa Térmica','Mini Liquidificador','Garrafa Stanley','Giro Roleta Dourada'];
for (let i = PRIZES.length - 1; i > 0; i--) {
  const j = Math.floor(Math.random() * (i + 1));
  [PRIZES[i], PRIZES[j]] = [PRIZES[j], PRIZES[i]];
}
const OMEGA_RANGE = [10, 22];
const DECEL_RANGE = [2.2, 3.8];

/* =========================
   VARS & CANVAS
========================= */
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const resultText = document.getElementById('resultText');
const spinBtn = document.getElementById('spinBtn');
const resetBtn = document.getElementById('resetBtn');
const closeBtn = document.getElementById('closeBtn');
const hint = document.getElementById('hint');
const fsBtn = document.getElementById('fsBtn');
const somVitoria = document.getElementById('somVitoria');
let W = canvas.width, H = canvas.height;
let cx = W/2, cy = H/2;
let R = Math.min(W,H)/2 - 46;
document.querySelector('.pointer').style.setProperty('--r', `${R}px`);
let angle = 0, omega = 0, decel = 0, spinning = false;
let particles = [];
const off = document.createElement('canvas'); off.width=W; off.height=H;
const offctx=off.getContext('2d');

/* =========================
   ÁUDIO GERADO EM TEMPO REAL
========================= */
let audioCtx = null;
function ensureAudio(){
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function beep(freq = 1750, ms = 35, gain = 0.08){
  if (!audioCtx) return;
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.type = 'square';
  o.frequency.value = freq;
  g.gain.value = gain;
  o.connect(g).connect(audioCtx.destination);
  const t = audioCtx.currentTime;
  o.start(t);
  o.stop(t + ms / 1000);
}

/* =========================
   CONFETE 
========================= */
class Confetti{
  constructor(x,y){this.x=x+(Math.random()*60-30);this.y=y+(Math.random()*40-20);
    this.vx=(Math.random()*700-350);this.vy=-(Math.random()*800+350);
    this.size=3+Math.random()*5;this.life=0;this.max=1.9+Math.random()*1.3;
    const hue = Math.random()*360;
    const saturation = 40 + Math.random()*30;
    const lightness = 70 + Math.random()*20;
    this.color=`hsl(${hue},${saturation}%,${lightness}%)`}
  update(dt){this.life+=dt;this.vy+=1200*dt;this.x+=this.vx*dt;this.y+=this.vy*dt}
  draw(ctx){if(this.life<this.max){ctx.fillStyle=this.color;ctx.fillRect(this.x,this.y,this.size,this.size)}}
}

/* =========================
   LÓGICA DE DESENHO DA ROLETA 
========================= */
function fitFontSize(ctx, text, maxWidth, maxSize, minSize = 14) {
  let s = maxSize;
  if (text.includes('|')) {
    const lines = text.split('|');
    const longestLine = lines.reduce((a, b) => a.length > b.length ? a : b);
    text = longestLine;
  }
  while (s > minSize) {
    ctx.font = `bold ${s}px system-ui, sans-serif`;
    if (ctx.measureText(text).width <= maxWidth) break;
    s--;
  }
  return Math.max(s, minSize);
}
function drawBase(){
  offctx.clearRect(0,0,W,H);
  const n=PRIZES.length, seg=(Math.PI*2)/n;
  const vibrantOrange = '#f3983e';
  const iceWhite = '#f7f5f2';
  const hubBlack = '#000000';
  const darkerOrangeFor3D = '#c9711f';
  for(let i=0;i<n;i++){
    const a0=i*seg,a1=(i+1)*seg;
    const sectorColor = (i % 2 === 0) ? vibrantOrange : iceWhite;
    offctx.beginPath();offctx.moveTo(cx,cy);offctx.arc(cx,cy,R,a0,a1);offctx.closePath();
    offctx.fillStyle = sectorColor;
    offctx.fill();
  }
  for(let i=0;i<n;i++){
    const a0 = i * seg;
    offctx.save();
    offctx.beginPath();
    offctx.moveTo(cx,cy);
    offctx.lineTo(cx + R * Math.cos(a0 + 0.005), cy + R * Math.sin(a0 + 0.005));
    offctx.strokeStyle = darkerOrangeFor3D;
    offctx.lineWidth = 6;
    offctx.stroke();
    offctx.restore();
    offctx.beginPath();
    offctx.moveTo(cx,cy);
    offctx.lineTo(cx + R * Math.cos(a0), cy + R * Math.sin(a0));
    offctx.strokeStyle = vibrantOrange;
    offctx.lineWidth = 4;
    offctx.stroke();
  }
  const rimTotalWidth = 40;
  const outerArcWidth = 6;
  const innerArcWidth = 6;
  const blackMetalGrad = offctx.createRadialGradient(cx, cy, R, cx, cy, R + rimTotalWidth);
  blackMetalGrad.addColorStop(0, '#333');
  blackMetalGrad.addColorStop(0.5, '#000');
  blackMetalGrad.addColorStop(1, '#333');
  offctx.beginPath();
  offctx.arc(cx, cy, R + rimTotalWidth / 2, 0, Math.PI * 2);
  offctx.strokeStyle = blackMetalGrad;
  offctx.lineWidth = rimTotalWidth;
  offctx.stroke();
  const numBulbs = 24;
  for (let i = 0; i < numBulbs; i++) {
    const angle = i * (Math.PI*2/numBulbs);
    const x = cx + (R + rimTotalWidth/2) * Math.cos(angle);
    const y = cy + (R + rimTotalWidth/2) * Math.sin(angle);
    offctx.save();
    offctx.shadowColor = '#FFFFFF'; offctx.shadowBlur = 8;
    offctx.beginPath(); offctx.arc(x, y, 10, 0, Math.PI * 2);
    offctx.fillStyle = '#f0f0f0'; offctx.fill();
    offctx.restore();
  }
  const orangeHighlight = '#ffb96e';
  const orangeShadow = '#a35e05';
  offctx.shadowColor = orangeShadow;
  offctx.shadowBlur = 3;
  offctx.shadowOffsetX = 2;
  offctx.shadowOffsetY = 2;
  offctx.beginPath();
  offctx.arc(cx, cy, R + rimTotalWidth - (outerArcWidth / 2), 0, Math.PI * 2);
  offctx.strokeStyle = vibrantOrange;
  offctx.lineWidth = outerArcWidth;
  offctx.stroke();
  offctx.beginPath();
  offctx.arc(cx, cy, R + (innerArcWidth / 2), 0, Math.PI * 2);
  offctx.strokeStyle = vibrantOrange;
  offctx.lineWidth = innerArcWidth;
  offctx.stroke();
  offctx.shadowColor = orangeHighlight;
  offctx.shadowOffsetX = -2;
  offctx.shadowOffsetY = -2;
  offctx.stroke();
  offctx.beginPath();
  offctx.arc(cx, cy, R + rimTotalWidth - (outerArcWidth / 2), 0, Math.PI * 2);
  offctx.stroke();
  offctx.shadowColor = 'transparent';
  offctx.shadowBlur = 0;
  offctx.shadowOffsetX = 0;
  offctx.shadowOffsetY = 0;
  for(let i=0;i<n;i++){
    const mid=i*seg+seg/2;
    const textRadius = R * 0.65;
    const sectorColor = (i % 2 === 0) ? vibrantOrange : iceWhite;
    const textColor = (sectorColor === vibrantOrange) ? iceWhite : vibrantOrange;
    const prizeText = PRIZES[i];
    let fontSize;
    if (prizeText.includes('|')) {
      fontSize = fitFontSize(offctx, prizeText, R * 0.45, Math.round(R * 0.09));
    } else {
      fontSize = fitFontSize(offctx, prizeText, R * 0.60, Math.round(R * 0.12));
    }
    offctx.save();
    offctx.translate(cx + textRadius * Math.cos(mid), cy + textRadius * Math.sin(mid));
    offctx.rotate(mid);
    offctx.textAlign='center';
    offctx.textBaseline='middle';
    offctx.font=`bold ${fontSize}px system-ui, sans-serif`;
    offctx.fillStyle = textColor;
    offctx.shadowColor = 'rgba(0,0,0,0.5)';
    offctx.shadowBlur = 3;
    if (prizeText.includes('|')) {
      const lines = prizeText.split('|');
      const lineHeight = fontSize * 1.1;
      const startY = - (lineHeight * (lines.length - 1)) / 2;
      for (let j = 0; j < lines.length; j++) {
        offctx.fillText(lines[j], 0, startY + (j * lineHeight));
      }
    } else {
      offctx.fillText(prizeText, 0, 0);
    }
    offctx.restore();
  }
  const hubR = R * 0.30;
  offctx.beginPath(); offctx.arc(cx,cy,hubR,0,Math.PI*2); offctx.fillStyle = hubBlack; offctx.fill();
  offctx.beginPath(); offctx.arc(cx,cy,hubR,0,Math.PI*2); offctx.strokeStyle = vibrantOrange; offctx.lineWidth = 5; offctx.stroke();
  offctx.fillStyle = '#FFFFFF';
  offctx.textAlign = 'center'; offctx.textBaseline = 'middle';
  offctx.font = `900 ${hubR * 0.25}px system-ui, sans-serif`;
  offctx.fillText('ROLETA', cx, cy - hubR * 0.25);
  offctx.fillText('PREMIADA', cx, cy + hubR * 0.25);
}
drawBase();

/* =========================
   LÓGICA DO JOGO E ANIMAÇÃO
========================= */
function indexAtPointer(aRad,n){const seg=(Math.PI*2)/n;let th=(-Math.PI/2 - aRad)%(Math.PI*2);if(th<0)th+=Math.PI*2;return Math.floor(th/seg)}
function spin(){
  if(spinning) return;
  ensureAudio();
  overlay.classList.remove('show');
  hint.style.display='none';
  omega=randBetween(...OMEGA_RANGE);
  decel=randBetween(...DECEL_RANGE);
  spinning=true;
}
function resetAll(){particles.length=0; overlay.classList.remove('show'); hint.style.display=''}
let prev=performance.now();
let lastIdx = null;
function frame(ts){
  const dt=Math.min(0.033,(ts-prev)/1000); prev=ts;
  ctx.clearRect(0,0,W,H);
  if(spinning){
    angle += omega*dt; omega -= decel*dt;
    const idxNow = indexAtPointer(angle, PRIZES.length);
    if (lastIdx === null) lastIdx = idxNow;
    if (idxNow !== lastIdx) {
      beep(1600 + Math.min(1200, omega * 70), 30, 0.1);
      lastIdx = idxNow;
    }
    if(omega<=0){
      omega=0; spinning=false;
      const idx=indexAtPointer(angle,PRIZES.length);
      const prize=PRIZES[idx];
      resultText.textContent= prize;
      overlay.classList.add('show');
      if (somVitoria) { somVitoria.play(); }
      for(let i=0;i<380;i++) particles.push(new Confetti(cx, cy));
    }
  }
  ctx.save();ctx.translate(cx,cy);ctx.rotate(angle);ctx.drawImage(off,-cx,-cy);ctx.restore();
  particles.forEach(p=>p.update(dt)); particles=particles.filter(p=>p.life<p.max); particles.forEach(p=>p.draw(ctx));
  requestAnimationFrame(frame);
}
requestAnimationFrame(frame);

/* =========================
   UTILS & EVENTOS
========================= */
function randBetween(a,b){return a + Math.random()*(b-a)}
function toggleFullscreen(){
  const doc=document, el=doc.documentElement;
  if(!doc.fullscreenElement) el.requestFullscreen?.({navigationUI:"hide"}) || el.webkitRequestFullscreen?.();
  else doc.exitFullscreen?.() || doc.webkitExitFullscreen?.();
}
spinBtn.addEventListener('click', () => spin());
resetBtn.addEventListener('click', () => resetAll());
closeBtn.addEventListener('click', () => overlay.classList.remove('show'));
fsBtn.addEventListener('click', toggleFullscreen);
window.addEventListener('keydown', (e) => {
  if (e.code === 'Space' && !spinning && !overlay.classList.contains('show')) {
    if (prizeModal.style.display === 'block') return;

    e.preventDefault();
    spin();
  }
  if (e.key.toLowerCase() === 'f') {
    toggleFullscreen();
  }
});
function resizeCanvas(){
  const rect=document.querySelector('.stage').getBoundingClientRect();
  const size=Math.min(rect.width, rect.height) - 40;
  const dpr=Math.min(2, window.devicePixelRatio || 1);
  canvas.width=Math.max(680, size)*dpr;
  canvas.height=Math.max(680, size)*dpr;
  canvas.style.width=canvas.width/dpr+'px';
  canvas.style.height=canvas.height/dpr+'px';
  W=canvas.width; H=canvas.height; cx=W/2; cy=H/2; R=Math.min(W,H)/2 - 46*dpr;
  document.querySelector('.pointer').style.setProperty('--r', `${R/dpr}px`);
  off.width=W; off.height=H; drawBase();
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function openPrizeEditor() {
  prizeInput.value = PRIZES.join('\n');
  prizeModal.style.display = 'block';
}

function closePrizeEditor() {
  prizeModal.style.display = 'none';
}

function savePrizes() {
  const newPrizes = prizeInput.value
    .split('\n')          
    .map(p => p.trim())   
    .filter(p => p);

  if (newPrizes.length > 0) {
    PRIZES.length = 0;
    PRIZES.push(...newPrizes);

    localStorage.setItem(localStorageKey, JSON.stringify(newPrizes));

    drawBase();

    alert('Prêmios salvos com sucesso!');
    closePrizeEditor();
  } else {
    alert('Por favor, adicione pelo menos um prêmio.');
  }
}

const prizeModal = document.getElementById('prizeModal');
const editPrizesBtn = document.getElementById('editPrizesBtn');
const cancelPrizesBtn = document.getElementById('cancelPrizesBtn');
const savePrizesBtn = document.getElementById('savePrizesBtn');
const prizeInput = document.getElementById('prizeInput');

editPrizesBtn.addEventListener('click', openPrizeEditor);
document.querySelector('.close-button').addEventListener('click', closePrizeEditor);
cancelPrizesBtn.addEventListener('click', closePrizeEditor);
savePrizesBtn.addEventListener('click', savePrizes);

window.addEventListener('click', (event) => {
  if (event.target == prizeModal) {
    closePrizeEditor();
  }
});
</script>
</body>

</html>
